<!-- upload_receipt.html -->

{% extends "base.html" %}

{% block content %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-group">
        <label for="expense">Link to Existing Expense:</label>
        <input type="text" id="expense" name="expense" class="form-control" autocomplete="off" placeholder="Start typing to search...">
        <ul id="expense-list" class="list-group"></ul>
        <input type="hidden" id="selected-expense-id" name="selected_expense_id">
    </div>    
    
    <div class="form-group">
        <label for="receipt">Upload Receipt:</label>
        <input type="file" id="receipt" name="receipt" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
</form>

<script>
// JavaScript to filter expenses based on user input
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById('expense');
    const expenseList = document.getElementById('expense-list');
    const selectedExpenseIdInput = document.getElementById('selected-expense-id');

    const expenses = [
        {% for expense in expenses %}
        {
            id: "{{ expense.id }}",
            description: "{{ expense.description }}",
            amount: "{{ expense.amount }}"
        },
        {% endfor %}
    ];

    input.addEventListener('input', function() {
        const query = input.value.toLowerCase();
        expenseList.innerHTML = '';
        if (query.length > 1) {
            expenses.forEach(item => {
                if (item.description.toLowerCase().includes(query)) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.textContent = `${item.description} - $${item.amount}`;
                    li.dataset.id = item.id;
                    li.addEventListener('click', function() {
                        input.value = li.textContent;
                        expenseList.innerHTML = '';
                        selectedExpenseIdInput.value = li.dataset.id; // Store the selected expense ID
                    });
                    expenseList.appendChild(li);
                }
            });
        }
    });
});
</script>
{% endblock %}
